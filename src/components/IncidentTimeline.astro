---
import Card from './ui/Card.astro';
---

<div id="incident-timeline">
  <div id="incident-loading" class="text-center py-12">
    <div class="inline-block animate-spin rounded-full h-8 w-8 border-b-2 border-[rgb(var(--color-clay))]"></div>
    <p class="mt-4 text-[rgb(var(--color-text-muted))]">Loading incident history...</p>
  </div>

  <div id="incident-error" class="hidden text-center py-12">
    <p class="text-red-600 dark:text-red-400">Failed to load incident history. Please try again later.</p>
  </div>

  <div id="incident-content" class="hidden space-y-6"></div>
</div>

<script>
  interface Incident {
    title: string;
    link: string;
    description: string;
    pubDate: Date;
    guid: string;
  }

  async function loadIncidentHistory() {
    const loadingEl = document.getElementById('incident-loading');
    const errorEl = document.getElementById('incident-error');
    const contentEl = document.getElementById('incident-content');

    if (!loadingEl || !errorEl || !contentEl) return;

    try {
      const response = await fetch('https://status.claude.com/history.rss');
      if (!response.ok) throw new Error('Failed to fetch RSS feed');

      const xmlText = await response.text();
      const parser = new DOMParser();
      const xmlDoc = parser.parseFromString(xmlText, 'text/xml');

      const items = Array.from(xmlDoc.querySelectorAll('item'));
      const incidents: Incident[] = items.map(item => ({
        title: item.querySelector('title')?.textContent || '',
        link: item.querySelector('link')?.textContent || '',
        description: item.querySelector('description')?.textContent || '',
        pubDate: new Date(item.querySelector('pubDate')?.textContent || ''),
        guid: item.querySelector('guid')?.textContent || ''
      }));

      // Show only the 10 most recent incidents
      const recentIncidents = incidents.slice(0, 10);

      contentEl.innerHTML = recentIncidents.map(incident => {
        const formattedDate = incident.pubDate.toLocaleDateString('en-US', {
          month: 'short',
          day: 'numeric',
          year: 'numeric'
        });

        // Parse the description to extract individual status updates
        const updates = incident.description
          .split(/<br\s*\/?>/gi)
          .filter(line => line.trim())
          .map(line => {
            // Remove <small> tags and extract timestamp
            const cleanLine = line.replace(/<\/?small>/gi, '');
            return cleanLine.trim();
          })
          .filter(line => line.length > 0);

        const statusUpdates = updates.map(update => {
          // Determine status type from content
          let statusColor = 'text-gray-600 dark:text-gray-400';
          if (update.includes('Resolved') || update.includes('resolved')) {
            statusColor = 'text-green-600 dark:text-green-400';
          } else if (update.includes('Investigating') || update.includes('investigating')) {
            statusColor = 'text-yellow-600 dark:text-yellow-400';
          } else if (update.includes('Identified') || update.includes('identified')) {
            statusColor = 'text-orange-600 dark:text-orange-400';
          } else if (update.includes('Monitoring') || update.includes('monitoring')) {
            statusColor = 'text-blue-600 dark:text-blue-400';
          }

          return `<div class="pl-4 border-l-2 border-[rgb(var(--color-border))] py-2">
            <p class="${statusColor} text-sm">${update}</p>
          </div>`;
        }).join('');

        return `
          <div class="p-6 border border-[rgb(var(--color-border))] rounded-lg bg-[rgb(var(--color-surface))] hover:border-[rgb(var(--color-clay))] transition-colors">
            <div class="flex items-start justify-between gap-4 mb-3">
              <h3 class="text-lg font-mono font-semibold flex-1">
                <a href="${incident.link}" target="_blank" rel="noopener noreferrer" class="hover:text-[rgb(var(--color-clay))] transition-colors">
                  ${incident.title}
                </a>
              </h3>
              <span class="text-sm text-[rgb(var(--color-text-muted))] font-mono whitespace-nowrap">${formattedDate}</span>
            </div>
            <div class="space-y-2">
              ${statusUpdates}
            </div>
          </div>
        `;
      }).join('');

      loadingEl.classList.add('hidden');
      contentEl.classList.remove('hidden');
    } catch (error) {
      console.error('Error loading incident history:', error);
      loadingEl.classList.add('hidden');
      errorEl.classList.remove('hidden');
    }
  }

  // Load incidents when page loads
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', loadIncidentHistory);
  } else {
    loadIncidentHistory();
  }
</script>
