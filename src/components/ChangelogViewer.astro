---
// Client-side fetching only - no build-time data
---

<div class="w-full">
  <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4 mb-6">
    <div>
      <h2 class="text-3xl font-mono font-bold mb-2">Claude Code Changelog</h2>
      <p class="text-[rgb(var(--color-text-muted))]">
        Track every change and improvement to Claude Code
      </p>
    </div>
    <button
      id="refresh-changelog-btn"
      class="inline-flex items-center gap-2 px-4 py-2 text-sm font-mono font-medium bg-[rgb(var(--color-clay))] text-white rounded-lg hover:bg-[rgb(var(--color-clay-dark))] transition-all duration-300 clay-glow hover:scale-105 disabled:opacity-50 disabled:cursor-not-allowed"
      title="Fetch the latest changelog"
    >
      <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" />
      </svg>
      <span id="refresh-text">Refresh</span>
    </button>
  </div>

  <!-- Loading State -->
  <div id="changelog-loading" class="w-full h-[600px] border border-[rgb(var(--color-border))] rounded-lg shadow-sm bg-[rgb(var(--color-surface))]">
    <div class="flex flex-col items-center justify-center h-full">
      <div class="inline-block w-8 h-8 border-4 border-[rgb(var(--color-border))] border-t-[rgb(var(--color-clay))] rounded-full animate-spin mb-4"></div>
      <p class="text-[rgb(var(--color-text-muted))] font-mono">Loading changelog...</p>
    </div>
  </div>

  <!-- Error State (hidden by default) -->
  <div id="changelog-error" class="hidden w-full h-[600px] border border-[rgb(var(--color-border))] rounded-lg shadow-sm bg-[rgb(var(--color-surface))]">
    <div class="flex flex-col items-center justify-center h-full p-8">
      <p class="text-[rgb(var(--color-text-muted))] mb-4">
        Unable to load changelog at this time.
      </p>
      <button
        id="retry-changelog-btn"
        class="inline-flex items-center gap-2 px-4 py-2 text-sm font-mono font-medium bg-[rgb(var(--color-clay))] text-white rounded-lg hover:bg-[rgb(var(--color-clay-dark))] transition-all duration-300"
      >
        Try Again
      </button>
    </div>
  </div>

  <!-- Content Container (hidden by default) -->
  <div id="changelog-container" class="hidden w-full h-[600px] overflow-y-auto border border-[rgb(var(--color-border))] rounded-lg shadow-sm bg-[rgb(var(--color-surface))] changelog-scroll">
    <div
      id="changelog-content"
      class="prose prose-lg prose-slate dark:prose-invert max-w-none p-8
        prose-headings:font-mono prose-headings:font-bold
        prose-h1:text-3xl prose-h1:border-b prose-h1:border-[rgb(var(--color-border))] prose-h1:pb-4
        prose-h2:text-2xl prose-h2:mt-8
        prose-a:text-[rgb(var(--color-clay))] prose-a:no-underline hover:prose-a:underline
        prose-code:text-[rgb(var(--color-clay))] prose-code:bg-[rgba(var(--color-clay),0.1)] prose-code:px-1 prose-code:py-0.5 prose-code:rounded prose-code:font-mono prose-code:before:content-[''] prose-code:after:content-['']
        prose-strong:text-[rgb(var(--color-text))]
        prose-ul:list-disc prose-ul:pl-6
        prose-li:text-[rgb(var(--color-text))]">
    </div>
  </div>

  <div class="mt-4 text-sm text-[rgb(var(--color-text-muted))] text-center">
    Source: <a
      href="https://github.com/anthropics/claude-code/blob/main/CHANGELOG.md"
      target="_blank"
      rel="noopener noreferrer"
      class="text-[rgb(var(--color-clay))] hover:underline"
    >
      github.com/anthropics/claude-code
    </a>
  </div>
</div>

<script>
  import { marked } from 'marked';

  marked.setOptions({
    gfm: true,
    breaks: true,
  });

  const loadingEl = document.getElementById('changelog-loading');
  const errorEl = document.getElementById('changelog-error');
  const containerEl = document.getElementById('changelog-container');
  const content = document.getElementById('changelog-content');
  const refreshBtn = document.getElementById('refresh-changelog-btn');
  const refreshText = document.getElementById('refresh-text');
  const retryBtn = document.getElementById('retry-changelog-btn');

  // Fetch and render changelog
  async function fetchChangelog(showLoading = true) {
    if (!content || !refreshText) return;

    if (showLoading) {
      // Show loading state
      loadingEl?.classList.remove('hidden');
      errorEl?.classList.add('hidden');
      containerEl?.classList.add('hidden');
    } else {
      // Update button state for refresh
      refreshBtn?.setAttribute('disabled', 'true');
      refreshText.textContent = 'Loading...';
    }

    // Rotate the refresh icon
    const icon = refreshBtn?.querySelector('svg');
    if (icon && !showLoading) {
      icon.classList.add('animate-spin');
    }

    try {
      const response = await fetch(
        'https://raw.githubusercontent.com/anthropics/claude-code/refs/heads/main/CHANGELOG.md',
        { cache: showLoading ? 'default' : 'reload' } // Force fresh fetch on manual refresh
      );

      if (!response.ok) {
        throw new Error('Failed to fetch changelog');
      }

      const markdown = await response.text();
      const html = marked.parse(markdown);
      content.innerHTML = html as string;

      // Show content, hide loading/error
      loadingEl?.classList.add('hidden');
      errorEl?.classList.add('hidden');
      containerEl?.classList.remove('hidden');

      // Success feedback for manual refresh
      if (!showLoading) {
        refreshText.textContent = 'Updated âœ“';
        setTimeout(() => {
          refreshText.textContent = 'Refresh';
        }, 2000);
      }
    } catch (error) {
      console.error('Failed to fetch changelog:', error);

      if (showLoading) {
        // Show error state on initial load
        loadingEl?.classList.add('hidden');
        errorEl?.classList.remove('hidden');
        containerEl?.classList.add('hidden');
      } else {
        // Show inline error on refresh
        content.innerHTML = '<p class="text-red-500 p-4">Failed to load changelog. Please check your connection and try again.</p>';
        refreshText.textContent = 'Try Again';
      }
    } finally {
      if (!showLoading) {
        refreshBtn?.removeAttribute('disabled');
        if (icon) {
          icon.classList.remove('animate-spin');
        }
      }
    }
  }

  // Refresh button click handler
  refreshBtn?.addEventListener('click', () => {
    fetchChangelog(false);
  });

  // Retry button click handler
  retryBtn?.addEventListener('click', () => {
    fetchChangelog(true);
  });

  // Fetch changelog on page load
  fetchChangelog(true);
</script>

<style>
  /* Custom scrollbar styling */
  .changelog-scroll::-webkit-scrollbar {
    width: 10px;
  }

  .changelog-scroll::-webkit-scrollbar-track {
    background: rgb(var(--color-surface));
    border-left: 1px solid rgb(var(--color-border));
  }

  .changelog-scroll::-webkit-scrollbar-thumb {
    background: rgba(var(--color-clay), 0.3);
    border-radius: 5px;
  }

  .changelog-scroll::-webkit-scrollbar-thumb:hover {
    background: rgba(var(--color-clay), 0.5);
  }

  /* Firefox scrollbar */
  .changelog-scroll {
    scrollbar-width: thin;
    scrollbar-color: rgba(var(--color-clay), 0.3) rgb(var(--color-surface));
  }
</style>
